<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falka ‚Ä¢ Valorant Agent Selector (FR/EN)</title>

  <!-- Police "style Valorant" (proche) pour les titres -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0f1a;
      --panel:#0f1526;
      --panel2:#141b2e;
      --text:#e9eefc;

      /* Inspir√© du logo Falka (rouge + cr√®me) */
      --f-red:#e5393b;
      --f-cream:#e6d2ad;

      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(229,57,59,.20), transparent 60%),
        radial-gradient(700px 420px at 80% 15%, rgba(230,210,173,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    header{
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(11,15,26,.92), rgba(11,15,26,.86));
      backdrop-filter: blur(8px);
    }
    .headerWrap{
      max-width:980px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width:260px; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      border:1px solid var(--stroke2);
      background:#000; object-fit:cover;
    }
    .brandText{ display:flex; flex-direction:column; line-height:1; }
    .pseudo{
      font-family:"Bebas Neue", system-ui, sans-serif;
      letter-spacing:.10em; font-size:26px; color:var(--text);
    }
    .subbrand{ margin-top:4px; font-size:12px; color:rgba(233,238,252,.72); }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label.muted{ color: rgba(233,238,252,.70); font-size:13px; }
    select, button{
      background: var(--panel2); color: var(--text);
      border: 1px solid var(--stroke2);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
    }
    button.primary{
      background: linear-gradient(135deg, rgba(229,57,59,.95), rgba(229,57,59,.78));
      border-color: rgba(255,255,255,.14);
      box-shadow: 0 12px 34px rgba(229,57,59,.18);
    }
    button.ghost{ background: transparent; }

    main{ max-width:980px; margin:0 auto; padding:18px 16px 18px; }
    .card{
      background: linear-gradient(180deg, rgba(15,21,38,.92), rgba(15,21,38,.86));
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:16px;
      margin:14px 0;
      box-shadow: 0 10px 34px rgba(0,0,0,.28);
    }
    .title{
      font-family:"Bebas Neue", system-ui, sans-serif;
      letter-spacing:.08em;
      font-size:44px;
      margin:10px 0 6px;
    }
    .muted{ color: rgba(233,238,252,.74); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill{
      padding:7px 11px; border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(20,27,46,.72);
      font-size:13px;
    }
    .pill.red{ border-color: rgba(229,57,59,.55); box-shadow: inset 0 0 0 1px rgba(229,57,59,.10); }
    .pill.cream{ border-color: rgba(230,210,173,.45); box-shadow: inset 0 0 0 1px rgba(230,210,173,.08); }
    .qtitle{ font-size:18px; font-weight:800; margin:6px 0 10px; }
    .answers{ display:grid; gap:10px; }
    .ans{
      text-align:left;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(20,27,46,.95);
      transition: transform .05s ease, border-color .12s ease, box-shadow .12s ease;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .ans:hover{
      transform: translateY(-1px);
      border-color: rgba(230,210,173,.28);
      box-shadow: 0 10px 26px rgba(0,0,0,.20);
    }
    .footerBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:720px){ .grid2{ grid-template-columns:1fr; } }
    .resultBig{
      font-family:"Bebas Neue", system-ui, sans-serif;
      letter-spacing:.08em;
      font-size:40px;
      margin:10px 0 0;
    }
    .scoreWrap{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .scoreLine{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      background: rgba(20,27,46,.95);
      border:1px solid var(--stroke);
      width:min(420px,100%);
    }
    .scoreLine b{ font-weight:900; }

    footer{ max-width:980px; margin:0 auto; padding:0 16px 34px; }
    .footerCard{
      background: linear-gradient(180deg, rgba(15,21,38,.92), rgba(15,21,38,.80));
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 10px 34px rgba(0,0,0,.22);
    }
    .footerTitle{
      font-family:"Bebas Neue", system-ui, sans-serif;
      letter-spacing:.08em;
      font-size:26px;
      margin:0 0 8px;
    }
    .socialList{ display:grid; gap:10px; margin-top:10px; }
    .socialItem{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 12px; border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(20,27,46,.75);
    }
    .socialLeft{ display:flex; align-items:center; gap:10px; }
    .badge{
      width:10px; height:10px; border-radius:999px;
      background: var(--f-red);
      box-shadow: 0 0 0 4px rgba(229,57,59,.10);
    }
    .socialName{ font-weight:800; }
    .socialLink a{ color: var(--f-cream); text-decoration:none; font-weight:800; }
    .socialLink a:hover{ text-decoration:underline; }
  </style>
</head>

<body>
  <header>
    <div class="headerWrap">
      <div class="brand">
        <img class="logo" src="falka-logo.png" alt="Logo Falka" />
        <div class="brandText">
          <div class="pseudo">FALKA</div>
          <div class="subbrand" id="subbrand">Agent Selector ‚Ä¢ Valorant</div>
        </div>
      </div>

      <div class="controls">
        <label class="muted" for="langSel" id="langLabel">Langue</label>
        <select id="langSel" aria-label="Language">
          <option value="fr">üá´üá∑ Fran√ßais</option>
          <option value="en">üá¨üáß English</option>
        </select>
        <button class="ghost" id="restartBtn">Recommencer</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card" id="introCard">
      <div class="row">
        <span class="pill red" id="pill1">10 + 10 questions</span>
        <span class="pill cream" id="pill2">R√¥le ‚Üí Agent</span>
        <span class="pill" id="pill3">D√©partage si √©galit√©</span>
      </div>

      <div class="title" id="title">Quel agent Valorant te correspond ?</div>
      <p class="muted" id="subtitle" style="margin:0;">
        10 questions pour trouver ton r√¥le, puis 10 questions pour trouver ton agent dans ce r√¥le.
      </p>

      <div class="footerBtns">
        <button class="primary" id="startBtn">Commencer</button>
      </div>

      <p class="muted" id="disclaimer" style="margin-top:10px; font-size:13px;">
        Note : ce quiz donne une recommandation bas√©e sur ton style. Mets √† jour la liste d‚Äôagents si Riot en ajoute.
      </p>
    </div>

    <div class="card" id="quizCard" style="display:none;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="muted" id="progress">Question 1 / 10</div>
        <span class="pill" id="phaseHint">Phase : R√¥le</span>
      </div>

      <div class="qtitle" id="qText">...</div>
      <div class="answers" id="answers"></div>

      <div class="footerBtns">
        <button id="backBtn">Retour</button>
      </div>
    </div>

    <div class="card" id="tiebreakCard" style="display:none;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="muted" id="tbTitle">Question bonus</div>
        <!-- IMPORTANT: pas de "X vs Y" affich√© -->
        <span class="pill red" id="tbBadge">D√©cision finale</span>
      </div>

      <div class="qtitle" id="tbText">...</div>
      <div class="answers" id="tbAnswers"></div>
    </div>

    <div class="card" id="resultCard" style="display:none;">
      <div class="row">
        <span class="pill red" id="pillMain">Agent principal</span>
        <span class="pill cream" id="pillAlt">Alternatives</span>
      </div>

      <div class="resultBig" id="mainAgent">‚Äî</div>
      <p class="muted" id="mainExplain" style="margin-top:0;">‚Äî</p>

      <div class="grid2" style="margin-top:12px;">
        <div class="card" style="margin:0;">
          <b id="alt1Title">Alternative #1</b>
          <div style="margin-top:8px; font-size:22px; font-weight:900;" id="alt1Agent">‚Äî</div>
          <div class="muted" id="alt1Why" style="margin-top:6px;">‚Äî</div>
        </div>
        <div class="card" style="margin:0;">
          <b id="alt2Title">Alternative #2</b>
          <div style="margin-top:8px; font-size:22px; font-weight:900;" id="alt2Agent">‚Äî</div>
          <div class="muted" id="alt2Why" style="margin-top:6px;">‚Äî</div>
        </div>
      </div>

      <h3 style="margin:16px 0 8px;" id="scoreTitle">Scores (agents)</h3>
      <div class="scoreWrap" id="scoreLines"></div>

      <div class="footerBtns">
        <button class="primary" id="retryBtn">Refaire le quiz</button>
        <button id="copyBtn">Copier le r√©sultat</button>
      </div>

      <p class="muted" id="noteMeta" style="margin-top:10px; font-size:13px;">
        Astuce : r√©ponds en pensant √† tes derniers matchs, pas √† ton humeur du moment.
      </p>
    </div>
  </main>

  <footer>
    <div class="footerCard">
      <div class="footerTitle" id="footerTitle">R√©seaux de Falka</div>
      <div class="muted" id="footerSubtitle">Retrouve Falka sur :</div>

      <div class="socialList">
        <div class="socialItem">
          <div class="socialLeft"><span class="badge"></span><span class="socialName">Twitch</span></div>
          <div class="socialLink"><a href="https://www.twitch.tv/falkalive" target="_blank" rel="noopener">FalkaLive</a></div>
        </div>
        <div class="socialItem">
          <div class="socialLeft"><span class="badge"></span><span class="socialName">TikTok</span></div>
          <div class="socialLink"><a href="https://www.tiktok.com/@falkalive" target="_blank" rel="noopener">Falka TikTok</a></div>
        </div>
      </div>

      <p class="muted" style="margin:12px 0 0; font-size:12px;">
        ¬© Falka ‚Ä¢ Fan project ‚Ä¢ Valorant est une marque de Riot Games.
      </p>
    </div>
  </footer>

<script>
(() => {
  const $ = (id) => document.getElementById(id);
  const clamp0 = (n) => Math.max(0, n);
  const pairKey = (a,b) => [a,b].sort().join("|");
  const initScoreMap = (keys) => Object.fromEntries(keys.map(k => [k, 0]));
  const sortedKeys = (scoreMap) => Object.entries(scoreMap)
    .map(([k,v]) => ({k,v}))
    .sort((a,b)=> b.v - a.v || a.k.localeCompare(b.k))
    .map(e => e.k);

  const LABELS = {
    fr: {
      language:"Langue", restart:"Recommencer", start:"Commencer", back:"Retour",
      phaseRole:"Phase : R√¥le", phaseAgent:"Phase : Agent",
      tiebreakTitle:"Question bonus", tiebreakBadge:"D√©cision finale",
      retake:"Refaire le quiz", copy:"Copier le r√©sultat", copied:"Copi√© ‚úÖ",
      scores:"Scores (agents)",
      alt1:"Alternative #1", alt2:"Alternative #2",
      socialsTitle:"R√©seaux de Falka", socialsSub:"Retrouve Falka sur :",
      introTitle:"Quel agent Valorant te correspond ?",
      introSub:"10 questions pour trouver ton r√¥le, puis 10 questions pour trouver ton agent dans ce r√¥le.",
      note:"Astuce : r√©ponds en pensant √† tes derniers matchs, pas √† ton humeur du moment.",
      roleExplain: {
        duelist: "Profil Duelist : impact direct, duels, prise d‚Äôespace.",
        initiator:"Profil Initiator : info + facilitation d‚Äôentr√©e.",
        controller:"Profil Controller : contr√¥le des lignes de vue et du tempo.",
        sentinel:"Profil Sentinel : s√©curit√©, tenue et anti-flank."
      }
    },
    en: {
      language:"Language", restart:"Restart", start:"Start", back:"Back",
      phaseRole:"Phase: Role", phaseAgent:"Phase: Agent",
      tiebreakTitle:"Bonus question", tiebreakBadge:"Final decision",
      retake:"Retake quiz", copy:"Copy result", copied:"Copied ‚úÖ",
      scores:"Scores (agents)",
      alt1:"Alternative #1", alt2:"Alternative #2",
      socialsTitle:"Falka‚Äôs socials", socialsSub:"Find Falka on:",
      introTitle:"Which Valorant agent fits you?",
      introSub:"10 questions to find your role, then 10 questions to find your agent within that role.",
      note:"Tip: answer thinking about your latest matches, not your current mood.",
      roleExplain: {
        duelist: "Duelist profile: direct impact, duels, space-taking.",
        initiator:"Initiator profile: info + enabling entries.",
        controller:"Controller profile: sightline and tempo control.",
        sentinel:"Sentinel profile: security, holding, anti-flank."
      }
    }
  };

  // --- Phase 1 (R√¥le) : vous remplacerez ce bloc par vos 10 questions finales
  const ROLE_QUESTIONS = [
    { fr:{ q:"Ton style naturel en d√©but de round ?", a:[
      ["J‚Äôentre en premier, je prends les duels.","duelist"],
      ["Je pr√©pare l‚Äôentr√©e avec mes utilitaires.","initiator"],
      ["Je contr√¥le la map avec des smokes.","controller"],
      ["Je s√©curise les arri√®res et je prot√®ge.","sentinel"],
    ]}, en:{ q:"Your natural style at round start?", a:[
      ["I entry first and take duels.","duelist"],
      ["I prepare the entry with utility.","initiator"],
      ["I control space with smokes.","controller"],
      ["I lock down and protect flanks.","sentinel"],
    ]}},
    { fr:{ q:"Quelle est ta plus grande force ?", a:[
      ["Mon aim.","duelist"],
      ["Ma communication / cr√©ation d‚Äôouverture.","initiator"],
      ["Ma vision strat√©gique.","controller"],
      ["Mon intelligence de jeu (timings, holds).","sentinel"],
    ]}, en:{ q:"What‚Äôs your biggest strength?", a:[
      ["My aim.","duelist"],
      ["My comms / enabling openings.","initiator"],
      ["My strategic vision.","controller"],
      ["My game sense (timings, holds).","sentinel"],
    ]}},
    { fr:{ q:"Tu pr√©f√®res gagner gr√¢ce √† :", a:[
      ["Des frags d√©cisifs.","duelist"],
      ["Des ouvertures cr√©√©es par l‚Äôinfo/flash.","initiator"],
      ["Le contr√¥le du tempo et des lignes de vue.","controller"],
      ["Des erreurs adverses punies et une d√©fense solide.","sentinel"],
    ]}, en:{ q:"You prefer winning through:", a:[
      ["Decisive kills.","duelist"],
      ["Openings via info/flash.","initiator"],
      ["Tempo and sightline control.","controller"],
      ["Punishing mistakes with solid defense.","sentinel"],
    ]}},
    { fr:{ q:"En situation 1vX tu :", a:[
      ["Cherches le duel rapide.","duelist"],
      ["Isoles avec tes capacit√©s (flash/reveal).","initiator"],
      ["Joues le timing et la map (smokes).","controller"],
      ["Forces les adversaires √† venir dans ton setup.","sentinel"],
    ]}, en:{ q:"In a 1vX you:", a:[
      ["Take fast duels.","duelist"],
      ["Isolate with utility (flash/reveal).","initiator"],
      ["Play timing and map control (smokes).","controller"],
      ["Force enemies into your setup.","sentinel"],
    ]}},
    { fr:{ q:"Ton niveau d‚Äôagressivit√© est plut√¥t :", a:[
      ["Tr√®s agressif.","duelist"],
      ["Agressif mais pr√©par√©.","initiator"],
      ["Calme, je dicte le tempo.","controller"],
      ["Patient, j‚Äôattends l‚Äôerreur.","sentinel"],
    ]}, en:{ q:"Your aggression level is:", a:[
      ["Very aggressive.","duelist"],
      ["Aggressive but prepared.","initiator"],
      ["Calm, I dictate tempo.","controller"],
      ["Patient, I wait for mistakes.","sentinel"],
    ]}},
    { fr:{ q:"Ton r√¥le pr√©f√©r√© dans l‚Äô√©quipe ?", a:[
      ["Carry / fragger.","duelist"],
      ["Facilitateur (entr√©e, info).","initiator"],
      ["Chef d‚Äôorchestre (smokes, rotations).","controller"],
      ["Pilier d√©fensif (holds, anti-flank).","sentinel"],
    ]}, en:{ q:"Your preferred team role?", a:[
      ["Carry / fragger.","duelist"],
      ["Facilitator (entry, info).","initiator"],
      ["Orchestrator (smokes, rotations).","controller"],
      ["Defensive anchor (holds, anti-flank).","sentinel"],
    ]}},
    { fr:{ q:"Tu te sens le plus fort :", a:[
      ["En prise de space (entry).","duelist"],
      ["En prise d‚Äôinfo et pr√©paration.","initiator"],
      ["En contr√¥le de site et d√©coupes.","controller"],
      ["En d√©fense / tenue.","sentinel"],
    ]}, en:{ q:"You feel strongest:", a:[
      ["Taking space (entry).","duelist"],
      ["Gathering info and setting up.","initiator"],
      ["Site control and slicing angles.","controller"],
      ["On defense / holding.","sentinel"],
    ]}},
    { fr:{ q:"Quelles capacit√©s t‚Äôattirent le plus ?", a:[
      ["Mobilit√© / dash.","duelist"],
      ["Flash / reveal / drone.","initiator"],
      ["Smokes / walls / vision denial.","controller"],
      ["Pi√®ges / ralentissements / gadgets.","sentinel"],
    ]}, en:{ q:"Which abilities attract you most?", a:[
      ["Mobility / dash.","duelist"],
      ["Flash / reveal / drone.","initiator"],
      ["Smokes / walls / vision denial.","controller"],
      ["Traps / slows / gadgets.","sentinel"],
    ]}},
    { fr:{ q:"Ton niveau m√©canique (m√©caniques pures) ?", a:[
      ["Tr√®s √©lev√©, je veux en profiter.","duelist"],
      ["Bon, mais je pr√©f√®re aider l‚Äôentr√©e.","initiator"],
      ["Moyen : je gagne via utilit√©.","controller"],
      ["Variable : je mise sur le placement.","sentinel"],
    ]}, en:{ q:"Your raw mechanics level?", a:[
      ["Very high, I want to leverage it.","duelist"],
      ["Good, but I prefer enabling entry.","initiator"],
      ["Average: I win through utility.","controller"],
      ["Situational: I rely on positioning.","sentinel"],
    ]}},
    { fr:{ q:"Tu veux √™tre :", a:[
      ["Le joueur flashy.","duelist"],
      ["Celui qui d√©clenche l‚Äôaction.","initiator"],
      ["Le cerveau du round.","controller"],
      ["Le pilier solide.","sentinel"],
    ]}, en:{ q:"You want to be:", a:[
      ["The flashy player.","duelist"],
      ["The play starter.","initiator"],
      ["The brain of the round.","controller"],
      ["The solid anchor.","sentinel"],
    ]}},
  ];

  // --- Phase 2: questions agents (d√©j√† fournies dans la version pr√©c√©dente)
  // Pour garder ce message lisible, je laisse les objets existants identiques:
  // ‚úÖ AGENTS_BY_ROLE
  // ‚úÖ AGENT_QUESTIONS_BY_ROLE
  // ‚úÖ TIEBREAK_BY_ROLE (tiebreaks par r√¥le)
  //
  // üëâ IMPORTANT: les agents sont cach√©s pendant les bonus:
  // - pas de "X vs Y"
  // - badge neutre "D√©cision finale / Final decision"
  //
  // (Tu peux coller ici tes blocs complets AGENT_QUESTIONS_BY_ROLE + TIEBREAK_BY_ROLE de ton fichier actuel.)

  // --- Copie/colle ici depuis ton fichier actuel (ou depuis ma r√©ponse pr√©c√©dente):
  const AGENTS_BY_ROLE = {
    duelist: ["Jett","Raze","Reyna","Phoenix","Yoru","Neon","Iso"],
    initiator: ["Sova","Skye","Fade","Breach","KAY/O","Gekko"],
    controller: ["Omen","Brimstone","Viper","Astra","Harbor","Clove"],
    sentinel: ["Killjoy","Cypher","Sage","Chamber","Deadlock"]
  };

  // === PLACEHOLDERS ===
  // Remplace ces placeholders par les blocs complets (AGENT_Q_* et TIEBREAK_BY_ROLE)
  // depuis ta version pr√©c√©dente (celle que tu utilises).
  const AGENT_QUESTIONS_BY_ROLE = {};  // <-- √Ä COLLER (duelist/initiator/controller/sentinel)
  const TIEBREAK_BY_ROLE = {};         // <-- √Ä COLLER (duelist/initiator/controller/sentinel)
  // === /PLACEHOLDERS ===

  // -------------------------
  // UI refs
  // -------------------------
  const introCard = $("introCard");
  const quizCard = $("quizCard");
  const tiebreakCard = $("tiebreakCard");
  const resultCard = $("resultCard");

  const langSel = $("langSel");
  const startBtn = $("startBtn");
  const restartBtn = $("restartBtn");
  const backBtn = $("backBtn");

  const qText = $("qText");
  const answersEl = $("answers");
  const progressEl = $("progress");
  const phaseHint = $("phaseHint");

  const tbTitle = $("tbTitle");
  const tbBadge = $("tbBadge");
  const tbText = $("tbText");
  const tbAnswers = $("tbAnswers");

  const mainAgent = $("mainAgent");
  const mainExplain = $("mainExplain");
  const alt1Agent = $("alt1Agent");
  const alt2Agent = $("alt2Agent");
  const alt1Why = $("alt1Why");
  const alt2Why = $("alt2Why");
  const scoreLines = $("scoreLines");

  const retryBtn = $("retryBtn");
  const copyBtn = $("copyBtn");

  // Text nodes
  const langLabel = $("langLabel");
  const title = $("title");
  const subtitle = $("subtitle");
  const pill1 = $("pill1");
  const pill2 = $("pill2");
  const pill3 = $("pill3");
  const disclaimer = $("disclaimer");
  const pillMain = $("pillMain");
  const pillAlt = $("pillAlt");
  const alt1Title = $("alt1Title");
  const alt2Title = $("alt2Title");
  const scoreTitle = $("scoreTitle");
  const noteMeta = $("noteMeta");
  const subbrand = $("subbrand");
  const footerTitle = $("footerTitle");
  const footerSubtitle = $("footerSubtitle");

  // -------------------------
  // State
  // -------------------------
  let lang = "fr";
  let phase = "role"; // "role" | "agent"
  let idx = 0;
  let history = [];

  let roleScores = initScoreMap(["duelist","initiator","controller","sentinel"]);
  let chosenRole = null;

  let agentScores = {};
  let chosenAgents = [];
  let pendingTie = null; // {roleKey, bracketList, winner, nextIndex, pickStage}
  let pickStage = 0;
  let lockedWinners = [];

  function setLanguage(newLang){
    lang = newLang;
    document.documentElement.lang = lang;

    langLabel.textContent = LABELS[lang].language;
    restartBtn.textContent = LABELS[lang].restart;
    startBtn.textContent = LABELS[lang].start;
    backBtn.textContent = LABELS[lang].back;

    subbrand.textContent = "Agent Selector ‚Ä¢ Valorant";

    title.textContent = LABELS[lang].introTitle;
    subtitle.textContent = LABELS[lang].introSub;

    pill1.textContent = "10 + 10 questions";
    pill2.textContent = (lang==="fr") ? "R√¥le ‚Üí Agent" : "Role ‚Üí Agent";
    pill3.textContent = (lang==="fr") ? "D√©partage si √©galit√©" : "Tiebreak if tied";
    disclaimer.textContent = (lang==="fr")
      ? "Note : ce quiz donne une recommandation bas√©e sur ton style. Mets √† jour la liste d‚Äôagents si Riot en ajoute."
      : "Note: this quiz recommends based on your playstyle. Update the agent list if Riot adds new agents.";

    tbTitle.textContent = LABELS[lang].tiebreakTitle;
    tbBadge.textContent = LABELS[lang].tiebreakBadge;

    pillMain.textContent = (lang==="fr") ? "Agent principal" : "Main agent";
    pillAlt.textContent  = (lang==="fr") ? "Alternatives" : "Alternatives";
    alt1Title.textContent = LABELS[lang].alt1;
    alt2Title.textContent = LABELS[lang].alt2;
    scoreTitle.textContent = LABELS[lang].scores;

    retryBtn.textContent = LABELS[lang].retake;
    copyBtn.textContent = LABELS[lang].copy;
    noteMeta.textContent = LABELS[lang].note;

    footerTitle.textContent = LABELS[lang].socialsTitle;
    footerSubtitle.textContent = LABELS[lang].socialsSub;

    if(quizCard.style.display !== "none") renderQuestion();
    if(tiebreakCard.style.display !== "none" && pendingTie) renderTiebreak();
    if(resultCard.style.display !== "none") renderAgentScores();
  }

  function showOnly(which){
    introCard.style.display = (which==="intro") ? "" : "none";
    quizCard.style.display  = (which==="quiz") ? "" : "none";
    tiebreakCard.style.display = (which==="tiebreak") ? "" : "none";
    resultCard.style.display = (which==="result") ? "" : "none";
  }

  function start(){
    phase = "role";
    idx = 0;
    history = [];
    chosenRole = null;

    roleScores = initScoreMap(["duelist","initiator","controller","sentinel"]);
    agentScores = {};
    chosenAgents = [];
    pendingTie = null;
    pickStage = 0;
    lockedWinners = [];

    showOnly("quiz");
    renderQuestion();
  }

  function currentQuestionSet(){
    if(phase === "role") return ROLE_QUESTIONS;
    return (AGENT_QUESTIONS_BY_ROLE[chosenRole] || []);
  }

  function renderQuestion(){
    const qs = currentQuestionSet();
    const q = qs[idx][lang];

    const total = qs.length;
    phaseHint.textContent = (phase === "role") ? LABELS[lang].phaseRole : LABELS[lang].phaseAgent;

    progressEl.textContent = (phase === "role")
      ? (lang==="fr" ? `R√¥le ‚Ä¢ Question ${idx+1} / ${total}` : `Role ‚Ä¢ Question ${idx+1} / ${total}`)
      : (lang==="fr" ? `Agent ‚Ä¢ Question ${idx+1} / ${total}` : `Agent ‚Ä¢ Question ${idx+1} / ${total}`);

    qText.textContent = q.q;
    answersEl.innerHTML = "";

    q.a.forEach(([label, awardKey]) => {
      const btn = document.createElement("button");
      btn.className = "ans";
      btn.type = "button";
      btn.textContent = label;
      btn.addEventListener("click", () => chooseAnswer(awardKey));
      answersEl.appendChild(btn);
    });

    backBtn.style.display = (idx>0) ? "" : "none";
  }

  function chooseAnswer(awardKey){
    history.push({ phase, qIndex: idx, awardedKey: awardKey });

    if(phase === "role"){
      roleScores[awardKey]++;

      idx++;
      if(idx < ROLE_QUESTIONS.length){
        renderQuestion();
      } else {
        chosenRole = finalizeRole();
        phase = "agent";
        idx = 0;
        agentScores = initScoreMap(AGENTS_BY_ROLE[chosenRole]);

        showOnly("quiz");
        renderQuestion();
      }
    } else {
      agentScores[awardKey]++;

      idx++;
      const qs = AGENT_QUESTIONS_BY_ROLE[chosenRole] || [];
      if(idx < qs.length){
        renderQuestion();
      } else {
        resolveTop3AgentsWithTies();
      }
    }
  }

  function goBack(){
    if(idx<=0) return;
    idx--;

    const last = history.pop();
    if(!last) return;

    if(last.phase === "role"){
      roleScores[last.awardedKey] = clamp0(roleScores[last.awardedKey]-1);
      phase = "role";
      chosenRole = null;
    } else {
      agentScores[last.awardedKey] = clamp0(agentScores[last.awardedKey]-1);
      phase = "agent";
    }
    renderQuestion();
  }

  function finalizeRole(){
    const ordered = Object.entries(roleScores)
      .map(([k,v])=>({k,v}))
      .sort((a,b)=> b.v - a.v || a.k.localeCompare(b.k));
    return ordered[0].k;
  }

  function resolveTop3AgentsWithTies(){
    pickStage = 0;
    lockedWinners = [];
    pendingTie = null;
    continuePicking();
  }

  function continuePicking(){
    if(pickStage >= 3){
      chosenAgents = lockedWinners.slice(0,3);
      finalizeResultsUI();
      return;
    }

    const remaining = Object.keys(agentScores).filter(a => !lockedWinners.includes(a));
    if(remaining.length === 0){
      finalizeResultsUI();
      return;
    }

    let max = -Infinity;
    remaining.forEach(a => { max = Math.max(max, agentScores[a]); });
    const tied = remaining.filter(a => agentScores[a] === max);

    if(tied.length === 1){
      lockedWinners.push(tied[0]);
      pickStage++;
      continuePicking();
      return;
    }

    startAgentTiebreak(tied);
  }

  function startAgentTiebreak(tiedAgents){
    pendingTie = {
      roleKey: chosenRole,
      bracketList: tiedAgents.slice(),
      winner: tiedAgents[0],
      nextIndex: 1,
      pickStage: pickStage
    };
    showOnly("tiebreak");
    renderTiebreak();
  }

  function renderTiebreak(){
    // ‚ö†Ô∏è Agents cach√©s : aucune mention de a/b dans l'UI.
    // On ne montre qu'un badge neutre + la question.

    const roleKey = pendingTie.roleKey;
    const a = pendingTie.winner;
    const b = pendingTie.bracketList[pendingTie.nextIndex];

    tbTitle.textContent = LABELS[lang].tiebreakTitle;
    tbBadge.textContent = LABELS[lang].tiebreakBadge;

    const bank = TIEBREAK_BY_ROLE[roleKey] || {};
    const key = pairKey(a,b);
    const tb = bank[key];

    const question = tb ? tb[lang].q : (lang==="fr" ? "Question bonus :" : "Bonus question:");
    const answers = tb ? tb[lang].a : [
      [(lang==="fr" ? "Option A" : "Option A"), a],
      [(lang==="fr" ? "Option B" : "Option B"), b],
    ];

    tbText.textContent = question;
    tbAnswers.innerHTML = "";

    answers.forEach(([label, agentName]) => {
      const btn = document.createElement("button");
      btn.className = "ans";
      btn.type = "button";
      btn.textContent = label;
      btn.addEventListener("click", () => chooseTiebreak(agentName));
      tbAnswers.appendChild(btn);
    });
  }

  function chooseTiebreak(chosenAgent){
    agentScores[chosenAgent]++;

    pendingTie.winner = chosenAgent;
    pendingTie.nextIndex++;

    if(pendingTie.nextIndex < pendingTie.bracketList.length){
      renderTiebreak();
      return;
    }

    const winner = pendingTie.winner;
    pendingTie = null;

    lockedWinners.push(winner);
    pickStage++;
    showOnly("quiz");
    continuePicking();
  }

  function finalizeResultsUI(){
    const ordered = sortedKeys(agentScores).filter(a => !lockedWinners.includes(a));
    while(lockedWinners.length < 3 && ordered.length) lockedWinners.push(ordered.shift());
    chosenAgents = lockedWinners.slice(0,3);

    const [main, alt1, alt2] = chosenAgents;

    mainAgent.textContent = main || "‚Äî";
    alt1Agent.textContent = alt1 || "‚Äî";
    alt2Agent.textContent = alt2 || "‚Äî";

    const roleExplain = LABELS[lang].roleExplain[chosenRole] || "";
    mainExplain.textContent = (lang==="fr")
      ? `R√¥le d√©tect√© : ${chosenRole.toUpperCase()} ‚Äî ${roleExplain}`
      : `Detected role: ${chosenRole.toUpperCase()} ‚Äî ${roleExplain}`;

    alt1Why.textContent = (lang==="fr")
      ? `Alternative coh√©rente dans ${chosenRole.toUpperCase()} (2e meilleur score).`
      : `Coherent alternative within ${chosenRole.toUpperCase()} (2nd best score).`;

    alt2Why.textContent = (lang==="fr")
      ? `Alternative coh√©rente dans ${chosenRole.toUpperCase()} (3e meilleur score).`
      : `Coherent alternative within ${chosenRole.toUpperCase()} (3rd best score).`;

    renderAgentScores();
    showOnly("result");
  }

  function renderAgentScores(){
    scoreTitle.textContent = LABELS[lang].scores;
    scoreLines.innerHTML = "";

    const ordered = Object.entries(agentScores)
      .map(([k,v])=>({k,v}))
      .sort((a,b)=> b.v - a.v || a.k.localeCompare(b.k));

    ordered.forEach(({k,v}) => {
      const line = document.createElement("div");
      line.className = "scoreLine";
      const left = document.createElement("div");
      left.innerHTML = `<b>${k}</b>`;
      const right = document.createElement("div");
      right.textContent = String(v);
      line.appendChild(left);
      line.appendChild(right);
      scoreLines.appendChild(line);
    });
  }

  async function copyResult(){
    const txt = (lang==="fr")
      ? `R√©sultat Falka:\n- R√¥le: ${chosenRole}\n- Agent: ${mainAgent.textContent}\n- Alternatives: ${alt1Agent.textContent}, ${alt2Agent.textContent}`
      : `Falka result:\n- Role: ${chosenRole}\n- Agent: ${mainAgent.textContent}\n- Alternatives: ${alt1Agent.textContent}, ${alt2Agent.textContent}`;

    try{
      await navigator.clipboard.writeText(txt);
      copyBtn.textContent = LABELS[lang].copied;
      setTimeout(()=> copyBtn.textContent = LABELS[lang].copy, 1200);
    } catch(e){
      alert((lang==="fr") ? "Copie impossible (navigateur)." : "Copy failed (browser).");
    }
  }

  // Events
  langSel.addEventListener("change", (e) => setLanguage(e.target.value));
  startBtn.addEventListener("click", start);
  restartBtn.addEventListener("click", () => showOnly("intro"));
  backBtn.addEventListener("click", goBack);
  retryBtn.addEventListener("click", start);
  copyBtn.addEventListener("click", copyResult);

  // Init
  setLanguage(langSel.value);
})();
</script>
</body>
</html>
