<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Falka ‚Ä¢ Valorant Agent Selector (FR/EN)</title>

  <!-- Police "style Valorant" (proche) pour les titres -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">

  <style>
    :root{
      color-scheme: dark;
      --bg:#0b0f1a;
      --panel:#0f1526;
      --panel2:#141b2e;
      --text:#e9eefc;

      --f-red:#e5393b;
      --f-cream:#e6d2ad;

      --stroke: rgba(255,255,255,.10);
      --stroke2: rgba(255,255,255,.14);
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(900px 500px at 20% 0%, rgba(229,57,59,.20), transparent 60%),
        radial-gradient(700px 420px at 80% 15%, rgba(230,210,173,.12), transparent 55%),
        var(--bg);
      color:var(--text);
    }
    header{
      padding:14px 16px;
      border-bottom:1px solid var(--stroke);
      position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(11,15,26,.92), rgba(11,15,26,.86));
      backdrop-filter: blur(8px);
    }
    .headerWrap{
      max-width:980px; margin:0 auto;
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; flex-wrap:wrap;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width:260px; }
    .logo{
      width:42px; height:42px; border-radius:14px;
      border:1px solid var(--stroke2);
      background:#000; object-fit:cover;
    }
    .brandText{ display:flex; flex-direction:column; line-height:1; }
    .pseudo{
      font-family:"Bebas Neue", system-ui, sans-serif;
      letter-spacing:.10em; font-size:26px; color:var(--text);
    }
    .subbrand{ margin-top:4px; font-size:12px; color:rgba(233,238,252,.72); }
    .controls{ display:flex; gap:10px; align-items:center; flex-wrap:wrap; }
    label.muted{ color: rgba(233,238,252,.70); font-size:13px; }
    select, button{
      background: var(--panel2); color: var(--text);
      border: 1px solid var(--stroke2);
      border-radius: 12px;
      padding: 10px 12px;
      cursor: pointer;
    }
    button.primary{
      background: linear-gradient(135deg, rgba(229,57,59,.95), rgba(229,57,59,.78));
      border-color: rgba(255,255,255,.14);
      box-shadow: 0 12px 34px rgba(229,57,59,.18);
    }
    button.ghost{ background: transparent; }

    main{ max-width:980px; margin:0 auto; padding:18px 16px 18px; }
    .card{
      background: linear-gradient(180deg, rgba(15,21,38,.92), rgba(15,21,38,.86));
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:16px;
      margin:14px 0;
      box-shadow: 0 10px 34px rgba(0,0,0,.28);
    }
    .title{
      font-family:"Bebas Neue", system-ui, sans-serif;
      letter-spacing:.08em;
      font-size:44px;
      margin:10px 0 6px;
    }
    .muted{ color: rgba(233,238,252,.74); }
    .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .pill{
      padding:7px 11px; border-radius:999px;
      border:1px solid var(--stroke2);
      background: rgba(20,27,46,.72);
      font-size:13px;
    }
    .pill.red{ border-color: rgba(229,57,59,.55); box-shadow: inset 0 0 0 1px rgba(229,57,59,.10); }
    .pill.cream{ border-color: rgba(230,210,173,.45); box-shadow: inset 0 0 0 1px rgba(230,210,173,.08); }
    .qtitle{ font-size:18px; font-weight:800; margin:6px 0 10px; }
    .answers{ display:grid; gap:10px; }
    .ans{
      text-align:left;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid var(--stroke2);
      background: rgba(20,27,46,.95);
      transition: transform .05s ease, border-color .12s ease, box-shadow .12s ease;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
    }
    .ans:hover{
      transform: translateY(-1px);
      border-color: rgba(230,210,173,.28);
      box-shadow: 0 10px 26px rgba(0,0,0,.20);
    }
    .footerBtns{ display:flex; gap:10px; flex-wrap:wrap; margin-top:14px; }
    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:12px; }
    @media (max-width:720px){ .grid2{ grid-template-columns:1fr; } }
    .resultBig{
      font-family:"Bebas Neue", system-ui, sans-serif;
      letter-spacing:.08em;
      font-size:40px;
      margin:10px 0 0;
    }
    .scoreWrap{ display:flex; gap:10px; flex-wrap:wrap; margin-top:10px; }
    .scoreLine{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:10px 12px; border-radius:14px;
      background: rgba(20,27,46,.95);
      border:1px solid var(--stroke);
      width:min(420px,100%);
    }
    .scoreLine b{ font-weight:900; }

    footer{ max-width:980px; margin:0 auto; padding:0 16px 34px; }
    .footerCard{
      background: linear-gradient(180deg, rgba(15,21,38,.92), rgba(15,21,38,.80));
      border:1px solid var(--stroke);
      border-radius:18px;
      padding:16px;
      box-shadow: 0 10px 34px rgba(0,0,0,.22);
    }
    .footerTitle{
      font-family:"Bebas Neue", system-ui, sans-serif;
      letter-spacing:.08em;
      font-size:26px;
      margin:0 0 8px;
    }
    .socialList{ display:grid; gap:10px; margin-top:10px; }
    .socialItem{
      display:flex; justify-content:space-between; align-items:center; gap:10px;
      padding:12px 12px; border-radius:14px;
      border:1px solid var(--stroke);
      background: rgba(20,27,46,.75);
    }
    .socialLeft{ display:flex; align-items:center; gap:10px; }
    .badge{
      width:10px; height:10px; border-radius:999px;
      background: var(--f-red);
      box-shadow: 0 0 0 4px rgba(229,57,59,.10);
    }
    .socialName{ font-weight:800; }
    .socialLink a{ color: var(--f-cream); text-decoration:none; font-weight:800; }
    .socialLink a:hover{ text-decoration:underline; }

    /* Ic√¥nes Twitch / TikTok */
    .socialIcon{
      width:22px;
      height:22px;
      object-fit:contain;
      filter: drop-shadow(0 0 4px rgba(229,57,59,0.4));
    }
  </style>
</head>

<body>
  <header>
    <div class="headerWrap">
      <div class="brand">
        <img class="logo" src="falka-logo.png" alt="Logo Falka" />
        <div class="brandText">
          <div class="pseudo">FALKA</div>
          <div class="subbrand" id="subbrand">Agent Selector ‚Ä¢ Valorant</div>
        </div>
      </div>

      <div class="controls">
        <label class="muted" for="langSel" id="langLabel">Langue</label>
        <select id="langSel" aria-label="Language">
          <option value="fr">üá´üá∑ Fran√ßais</option>
          <option value="en">üá¨üáß English</option>
        </select>
        <button class="ghost" id="restartBtn">Recommencer</button>
      </div>
    </div>
  </header>

  <main>
    <div class="card" id="introCard">
      <div class="row">
        <span class="pill red" id="pill1">10 questions</span>
        <span class="pill cream" id="pill2">R√¥le</span>
        <span class="pill" id="pill3">D√©partage si √©galit√©</span>
      </div>

      <div class="title" id="title">Quel r√¥le Valorant te correspond ?</div>
      <p class="muted" id="subtitle" style="margin:0;">
        10 questions pour trouver ton r√¥le.
      </p>

      <div class="footerBtns">
        <button class="primary" id="startBtn">Commencer</button>
      </div>

      <p class="muted" id="disclaimer" style="margin-top:10px; font-size:13px;">
        Note : ce quiz donne une recommandation bas√©e sur ton style.
      </p>
    </div>

    <div class="card" id="quizCard" style="display:none;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="muted" id="progress">Question 1 / 10</div>
        <span class="pill" id="phaseHint">Phase : R√¥le</span>
      </div>

      <div class="qtitle" id="qText">...</div>
      <div class="answers" id="answers"></div>

      <div class="footerBtns">
        <button id="backBtn">Retour</button>
      </div>
    </div>

    <!-- ‚úÖ R√©sultat R√îLE : et c'est FINI (pas de phase agent) -->
    <div class="card" id="roleCard" style="display:none;">
      <div class="row">
        <span class="pill red" id="rolePill">Votre r√¥le est</span>
        <span class="pill" id="rolePill2">R√©sultat</span>
      </div>

      <div class="resultBig" id="roleName">‚Äî</div>
      <p class="muted" id="roleExplain" style="margin-top:0;">‚Äî</p>

      <div class="footerBtns">
        <button class="primary" id="retryFromRoleBtn">Refaire le quiz</button>
      </div>

      <p class="muted" id="roleHint" style="margin-top:10px; font-size:13px;">
        (Clique sur ‚ÄúRefaire le quiz‚Äù pour recommencer.)
      </p>
    </div>

    <div class="card" id="tiebreakCard" style="display:none;">
      <div class="row" style="justify-content:space-between; align-items:center;">
        <div class="muted" id="tbTitle">Question bonus</div>
        <span class="pill red" id="tbBadge">D√©cision finale</span>
      </div>

      <div class="qtitle" id="tbText">...</div>
      <div class="answers" id="tbAnswers"></div>
      <p class="muted" id="tbHint" style="margin:10px 0 0; font-size:12px;"></p>
    </div>
  </main>

  <footer>
    <div class="footerCard">
      <div class="footerTitle" id="footerTitle">R√©seaux de Falka</div>
      <div class="muted" id="footerSubtitle">Retrouve Falka sur :</div>

      <div class="socialList">
        <div class="socialItem">
          <div class="socialLeft">
            <img src="ttv_rouge.png" class="socialIcon" alt="Twitch">
            <span class="socialName">Twitch</span>
          </div>
          <div class="socialLink"><a href="https://www.twitch.tv/falkalive" target="_blank" rel="noopener">FalkaLive</a></div>
        </div>
        <div class="socialItem">
          <div class="socialLeft">
            <img src="tiktok_logo_rouge.png" class="socialIcon" alt="TikTok">
            <span class="socialName">TikTok</span>
          </div>
          <div class="socialLink"><a href="https://www.tiktok.com/@falkalive" target="_blank" rel="noopener">Falka TikTok</a></div>
        </div>
      </div>

      <p class="muted" style="margin:12px 0 0; font-size:12px;">
        ¬© Falka ‚Ä¢ Fan project ‚Ä¢ Valorant est une marque de Riot Games.
      </p>
    </div>
  </footer>

<script>
(() => {
  // -------------------------
  // Helpers
  // -------------------------
  const $ = (id) => document.getElementById(id);
  const clamp0 = (n) => Math.max(0, n);
  const initScoreMap = (keys) => Object.fromEntries(keys.map(k => [k, 0]));
  const sortedKeys = (scoreMap) => Object.entries(scoreMap)
    .map(([k,v]) => ({k,v}))
    .sort((a,b)=> b.v - a.v || a.k.localeCompare(b.k))
    .map(e => e.k);

  function shuffleArray(arr){
    const a = arr.slice();
    for(let i=a.length-1;i>0;i--){
      const j = Math.floor(Math.random()*(i+1));
      [a[i], a[j]] = [a[j], a[i]];
    }
    return a;
  }

  // -------------------------
  // Labels
  // -------------------------
  const LABELS = {
    fr: {
      language:"Langue", restart:"Recommencer", start:"Commencer", back:"Retour",
      phaseRole:"Phase : R√¥le",
      tiebreakTitle:"Question bonus", tiebreakBadge:"D√©cision finale",
      tiebreakHint:"(Cette question n‚Äôappara√Æt qu‚Äôen cas d‚Äô√©galit√©.)",
      retake:"Refaire le quiz",
      socialsTitle:"R√©seaux de Falka", socialsSub:"Retrouve Falka sur :",
      introTitle:"Quel r√¥le Valorant te correspond ?",
      introSub:"10 questions pour trouver ton r√¥le.",
      note:"Astuce : r√©ponds en pensant √† tes derniers matchs, pas √† ton humeur du moment.",
      roleExplain: {
        duelist: "Profil Duelist : impact direct, duels, prise d‚Äôespace.",
        initiator:"Profil Initiator : info + facilitation d‚Äôentr√©e.",
        controller:"Profil Controller : contr√¥le des lignes de vue et du tempo.",
        sentinel:"Profil Sentinel : s√©curit√©, tenue et anti-flank."
      },
      roleCardPill:"Votre r√¥le est",
      roleCardStep:"R√©sultat",
      roleCardHint:"(Clique sur ‚ÄúRefaire le quiz‚Äù pour recommencer.)"
    },
    en: {
      language:"Language", restart:"Restart", start:"Start", back:"Back",
      phaseRole:"Phase: Role",
      tiebreakTitle:"Bonus question", tiebreakBadge:"Final decision",
      tiebreakHint:"(This only appears if there‚Äôs a tie.)",
      retake:"Retake quiz",
      socialsTitle:"Falka‚Äôs socials", socialsSub:"Find Falka on:",
      introTitle:"Which Valorant role fits you?",
      introSub:"10 questions to find your role.",
      note:"Tip: answer thinking about your latest matches, not your current mood.",
      roleExplain: {
        duelist: "Duelist profile: direct impact, duels, space-taking.",
        initiator:"Initiator profile: info + enabling entries.",
        controller:"Controller profile: sightline and tempo control.",
        sentinel:"Sentinel profile: security, holding, anti-flank."
      },
      roleCardPill:"Your role is",
      roleCardStep:"Result",
      roleCardHint:"(Click ‚ÄúRetake quiz‚Äù to restart.)"
    }
  };

  // -------------------------
  // Phase 1 - ROLE questions (inchang√©es)
  // -------------------------
  const ROLE_QUESTIONS = [
    {
      fr:{ q:"Au d√©but du round je veux :", a:[
        ["Tout faire pour que mon √©quipe reste en vie.","sentinel"],
        ["Analyser les adversaires pour frapper l√† o√π √ßa fait mal.","initiator"],
        ["Vite me fight et essayer de r√©cup√©rer des kills.","duelist"],
        ["Restreindre au maximum les adversaires.","controller"],
      ]},
      en:{ q:"At the start of the round I want to:", a:[
        ["Keep my team alive at all costs.","sentinel"],
        ["Analyze enemies and strike weaknesses.","initiator"],
        ["Fight quickly and get kills.","duelist"],
        ["Restrict enemies as much as possible.","controller"],
      ]}
    },
    {
      fr:{ q:"Quelle est ta plus grande force ?", a:[
        ["Mon aim.","duelist"],
        ["Mon gamesens.","controller"],
        ["Ma communication.","initiator"],
        ["Mon adaptation aux autres.","sentinel"],
      ]},
      en:{ q:"What is your biggest strength?", a:[
        ["My aim.","duelist"],
        ["My game sense.","controller"],
        ["My communication.","initiator"],
        ["My adaptability.","sentinel"],
      ]}
    },
    {
      fr:{ q:"Dans un round tu pr√©f√®res :", a:[
        ["Ne pas mourir.","controller"],
        ["Faire 1 kill.","duelist"],
        ["Faire 2 assists.","initiator"],
        ["Qu‚Äôaucun de tes mates ne meure.","sentinel"],
      ]},
      en:{ q:"In a round you prefer to:", a:[
        ["Stay alive.","controller"],
        ["Get 1 kill.","duelist"],
        ["Get 2 assists.","initiator"],
        ["Make sure no teammate dies.","sentinel"],
      ]}
    },
    {
      fr:{ q:"En situation de clutch 1v3, la premi√®re chose que tu fais :", a:[
        ["Tu √©conomises ton arme.","sentinel"],
        ["Tu r√©cup√®res des infos avec tes comp√©tences.","initiator"],
        ["Tu fais tomber le plus d‚Äôarmes possible.","controller"],
        ["Tu cherches le duel rapidement.","duelist"],
      ]},
      en:{ q:"In a 1v3 clutch, the first thing you do:", a:[
        ["Save your weapon.","sentinel"],
        ["Gather info with abilities.","initiator"],
        ["Try to drop as many weapons as possible.","controller"],
        ["Look for a quick duel.","duelist"],
      ]}
    },
    {
      fr:{ q:"Ton niveau d‚Äôimpatience :", a:[
        ["Je veux vite faire la diff√©rence.","duelist"],
        ["Je me fight quand tout le monde est pr√™t.","controller"],
        ["Calme, j‚Äôy vais quand les autres veulent.","initiator"],
        ["Patient, j‚Äôattends l‚Äôerreur.","sentinel"],
      ]},
      en:{ q:"Your level of impatience:", a:[
        ["I want to make the difference fast.","duelist"],
        ["I fight when everyone is ready.","controller"],
        ["Calm, I go when others go.","initiator"],
        ["Patient, I wait for mistakes.","sentinel"],
      ]}
    },
    {
      fr:{ q:"Le plus important pour toi :", a:[
        ["√ätre le meilleur joueur de l‚Äô√©quipe.","duelist"],
        ["Rendre mes mates excellents.","initiator"],
        ["Pousser les adversaires √† l‚Äôerreur.","controller"],
        ["Rendre les adversaires moins forts.","sentinel"],
      ]},
      en:{ q:"What matters most to you:", a:[
        ["Being the best player on the team.","duelist"],
        ["Making my teammates excellent.","initiator"],
        ["Forcing enemies into mistakes.","controller"],
        ["Making enemies weaker.","sentinel"],
      ]}
    },
    {
      fr:{ q:"Tu te sens le plus fort :", a:[
        ["En prise d‚Äôespace (entry).","duelist"],
        ["En prise d‚Äôinfo.","initiator"],
        ["Pour restreindre les adversaires.","controller"],
        ["Pour tenir une ligne.","sentinel"],
      ]},
      en:{ q:"You feel strongest:", a:[
        ["Taking space (entry).","duelist"],
        ["Gathering information.","initiator"],
        ["Restricting enemies.","controller"],
        ["Holding a line.","sentinel"],
      ]}
    },
    {
      fr:{ q:"Quelles capacit√©s t‚Äôattirent le plus ?", a:[
        ["Informations (Reveal, Flash).","initiator"],
        ["Mobilit√© (Dash / reposition).","duelist"],
        ["Atouts (ralentissements / heal).","sentinel"],
        ["Smokes & walls.","controller"],
      ]},
      en:{ q:"Which abilities attract you most?", a:[
        ["Information (Reveal, Flash).","initiator"],
        ["Mobility (Dash / reposition).","duelist"],
        ["Utility (slows / heal).","sentinel"],
        ["Smokes & walls.","controller"],
      ]}
    },
    {
      fr:{ q:"Ton niveau m√©canique ?", a:[
        ["Tr√®s √©lev√©, je veux en profiter.","duelist"],
        ["Bon, mais perfectible.","initiator"],
        ["Moyen : je gagne gr√¢ce √† l‚Äô√©quipe.","controller"],
        ["Variable : je mise sur le placement.","sentinel"],
      ]},
      en:{ q:"Your mechanical level?", a:[
        ["Very high, I want to use it.","duelist"],
        ["Good but improvable.","initiator"],
        ["Average: I win thanks to teamplay.","controller"],
        ["Situational: I rely on positioning.","sentinel"],
      ]}
    },
    {
      fr:{ q:"Tu veux √™tre :", a:[
        ["Le joueur d√©cisif.","duelist"],
        ["Le facilitateur.","initiator"],
        ["Le meneur de jeu.","controller"],
        ["Le joueur intuable.","sentinel"],
      ]},
      en:{ q:"You want to be:", a:[
        ["The decisive player.","duelist"],
        ["The enabler.","initiator"],
        ["The playmaker / leader.","controller"],
        ["The unkillable one.","sentinel"],
      ]}
    }
  ];

  // -------------------------
  // Tiebreak: traits (roles cach√©s)
  // -------------------------
  const ROLE_TRAITS = {
    fr: {
      duelist:"Je pr√©f√®re avoir un impact direct et prendre les duels.",
      initiator:"Je pr√©f√®re pr√©parer l‚Äôaction et cr√©er des ouvertures.",
      controller:"Je pr√©f√®re contr√¥ler le rythme et structurer le round.",
      sentinel:"Je pr√©f√®re s√©curiser, tenir et stabiliser l‚Äô√©quipe."
    },
    en: {
      duelist:"I prefer direct impact and taking duels.",
      initiator:"I prefer setting up action and creating openings.",
      controller:"I prefer controlling tempo and structuring the round.",
      sentinel:"I prefer securing, holding, and stabilizing the team."
    }
  };

  // -------------------------
  // UI refs
  // -------------------------
  const introCard = $("introCard");
  const quizCard = $("quizCard");
  const roleCard = $("roleCard");
  const tiebreakCard = $("tiebreakCard");

  const langSel = $("langSel");
  const startBtn = $("startBtn");
  const restartBtn = $("restartBtn");
  const backBtn = $("backBtn");

  const qText = $("qText");
  const answersEl = $("answers");
  const progressEl = $("progress");
  const phaseHint = $("phaseHint");

  const rolePill = $("rolePill");
  const rolePill2 = $("rolePill2");
  const roleName = $("roleName");
  const roleExplainEl = $("roleExplain");
  const roleHint = $("roleHint");
  const retryFromRoleBtn = $("retryFromRoleBtn");

  const tbTitle = $("tbTitle");
  const tbBadge = $("tbBadge");
  const tbText = $("tbText");
  const tbAnswers = $("tbAnswers");
  const tbHint = $("tbHint");

  const langLabel = $("langLabel");
  const title = $("title");
  const subtitle = $("subtitle");
  const pill1 = $("pill1");
  const pill2 = $("pill2");
  const pill3 = $("pill3");
  const disclaimer = $("disclaimer");
  const subbrand = $("subbrand");
  const footerTitle = $("footerTitle");
  const footerSubtitle = $("footerSubtitle");

  // -------------------------
  // State
  // -------------------------
  let lang = "fr";
  let idx = 0;
  let history = [];

  let roleScores = initScoreMap(["duelist","initiator","controller","sentinel"]);
  let chosenRole = null;

  let roleOrder = [];
  let renderedAnswers = {};

  let pendingTie = null;

  // -------------------------
  // Language setup
  // -------------------------
  function setLanguage(newLang){
    lang = newLang;
    document.documentElement.lang = lang;

    langLabel.textContent = LABELS[lang].language;
    restartBtn.textContent = LABELS[lang].restart;
    startBtn.textContent = LABELS[lang].start;
    backBtn.textContent = LABELS[lang].back;

    subbrand.textContent = "Agent Selector ‚Ä¢ Valorant";

    title.textContent = LABELS[lang].introTitle;
    subtitle.textContent = LABELS[lang].introSub;

    pill1.textContent = (lang==="fr") ? "10 questions" : "10 questions";
    pill2.textContent = (lang==="fr") ? "R√¥le" : "Role";
    pill3.textContent = (lang==="fr") ? "D√©partage si √©galit√©" : "Tiebreak if tied";

    disclaimer.textContent = (lang==="fr")
      ? "Note : ce quiz donne une recommandation bas√©e sur ton style."
      : "Note: this quiz recommends based on your playstyle.";

    tbTitle.textContent = LABELS[lang].tiebreakTitle;
    tbBadge.textContent = LABELS[lang].tiebreakBadge;
    tbHint.textContent = LABELS[lang].tiebreakHint;

    footerTitle.textContent = LABELS[lang].socialsTitle;
    footerSubtitle.textContent = LABELS[lang].socialsSub;

    // Textes √©cran r√¥le
    rolePill.textContent = LABELS[lang].roleCardPill;
    rolePill2.textContent = LABELS[lang].roleCardStep;
    roleHint.textContent = LABELS[lang].roleCardHint;
    retryFromRoleBtn.textContent = LABELS[lang].retake;

    if(quizCard.style.display !== "none") renderQuestion();

    if(roleCard.style.display !== "none"){
      renderRoleCard();
    }

    if(tiebreakCard.style.display !== "none" && pendingTie){
      if(!pendingTie.currentPool || pendingTie.currentPool.length === 0){
        prepareNextPool();
      } else {
        renderTiebreakPool();
      }
    }
  }

  // -------------------------
  // Navigation
  // -------------------------
  function showOnly(which){
    introCard.style.display = (which==="intro") ? "" : "none";
    quizCard.style.display  = (which==="quiz") ? "" : "none";
    roleCard.style.display  = (which==="role") ? "" : "none";
    tiebreakCard.style.display = (which==="tiebreak") ? "" : "none";
  }

  function start(){
    idx = 0;
    history = [];
    chosenRole = null;

    roleScores = initScoreMap(["duelist","initiator","controller","sentinel"]);

    pendingTie = null;

    roleOrder = shuffleArray([...Array(ROLE_QUESTIONS.length).keys()]);
    renderedAnswers = {};

    showOnly("quiz");
    renderQuestion();
  }

  function currentQuestionIndex(){
    return roleOrder[idx];
  }

  function renderQuestion(){
    const qs = ROLE_QUESTIONS;

    if(!roleOrder || roleOrder.length !== qs.length){
      roleOrder = shuffleArray([...Array(qs.length).keys()]);
    }

    const realIndex = currentQuestionIndex();
    const q = qs[realIndex]?.[lang];

    if(!q){
      alert(lang==="fr"
        ? "Erreur: questions manquantes."
        : "Error: missing questions.");
      showOnly("intro");
      return;
    }

    const total = qs.length;
    phaseHint.textContent = LABELS[lang].phaseRole;

    progressEl.textContent = (lang==="fr")
      ? `R√¥le ‚Ä¢ Question ${idx+1} / ${total}`
      : `Role ‚Ä¢ Question ${idx+1} / ${total}`;

    qText.textContent = q.q;
    answersEl.innerHTML = "";

    const stableKey = `role:${idx}`;
    let answers = q.a;

    if(renderedAnswers[stableKey]){
      answers = renderedAnswers[stableKey];
    } else {
      answers = shuffleArray(q.a);
      renderedAnswers[stableKey] = answers;
    }

    answers.forEach(([label, awardKey]) => {
      const btn = document.createElement("button");
      btn.className = "ans";
      btn.type = "button";
      btn.textContent = label;
      btn.addEventListener("click", () => chooseAnswer(awardKey));
      answersEl.appendChild(btn);
    });

    backBtn.style.display = (idx>0) ? "" : "none";
  }

  function chooseAnswer(awardKey){
    history.push({ qIndex: idx, realIndex: currentQuestionIndex(), awardedKey: awardKey });

    roleScores[awardKey]++;

    idx++;
    if(idx < ROLE_QUESTIONS.length){
      renderQuestion();
    } else {
      const entries = Object.entries(roleScores).map(([k,v])=>({k,v}));
      const max = Math.max(...entries.map(e => e.v));
      const tied = entries.filter(e => e.v === max).map(e => e.k);

      if(tied.length === 1){
        chosenRole = tied[0];
        showRoleResult(); // ‚úÖ FINI ICI
      } else {
        startTiebreak(tied);
      }
    }
  }

  function goBack(){
    if(idx<=0) return;
    idx--;

    const last = history.pop();
    if(!last) return;

    roleScores[last.awardedKey] = clamp0(roleScores[last.awardedKey]-1);
    chosenRole = null;

    renderQuestion();
  }

  // -------------------------
  // R√©sultat r√¥le (fin du quiz)
  // -------------------------
  function renderRoleCard(){
    if(!chosenRole){
      roleName.textContent = "‚Äî";
      roleExplainEl.textContent = "‚Äî";
      return;
    }
    roleName.textContent = chosenRole.toUpperCase();
    const explain = LABELS[lang].roleExplain?.[chosenRole] || "";
    roleExplainEl.textContent = explain || "‚Äî";
  }

  function showRoleResult(){
    renderRoleCard();
    showOnly("role"); // ‚úÖ on ne continue pas vers les agents
  }

  // -------------------------
  // Tiebreak (roles only) with pools-of-4
  // -------------------------
  function startTiebreak(tiedKeys){
    pendingTie = {
      traits: ROLE_TRAITS,
      candidates: shuffleArray(tiedKeys.slice()),
      nextRound: [],
      currentPool: []
    };
    showOnly("tiebreak");
    prepareNextPool();
  }

  function prepareNextPool(){
    if(!pendingTie) return;

    if(pendingTie.candidates.length === 0){
      if(pendingTie.nextRound.length === 1){
        const winner = pendingTie.nextRound[0];
        pendingTie = null;

        chosenRole = winner;
        showRoleResult(); // ‚úÖ FINI ICI (apr√®s d√©partage)
        return;
      }

      pendingTie.candidates = shuffleArray(pendingTie.nextRound.slice());
      pendingTie.nextRound = [];
    }

    pendingTie.currentPool = pendingTie.candidates.splice(0, 4);

    if(pendingTie.currentPool.length === 1){
      pendingTie.nextRound.push(pendingTie.currentPool[0]);
      pendingTie.currentPool = [];
      prepareNextPool();
      return;
    }

    renderTiebreakPool();
  }

  function renderTiebreakPool(){
    tbTitle.textContent = LABELS[lang].tiebreakTitle;
    tbBadge.textContent = LABELS[lang].tiebreakBadge;
    tbHint.textContent = LABELS[lang].tiebreakHint;

    tbText.textContent = (lang==="fr")
      ? "Laquelle te ressemble le plus ?"
      : "Which one fits you best?";

    tbAnswers.innerHTML = "";

    const pool = shuffleArray(pendingTie.currentPool);

    pool.forEach(key => {
      const trait = pendingTie.traits?.[lang]?.[key];
      if(!trait){
        alert(lang==="fr"
          ? "Erreur: traits manquants (tiebreak)."
          : "Error: missing traits (tiebreak).");
        showOnly("intro");
        return;
      }

      const btn = document.createElement("button");
      btn.className = "ans";
      btn.type = "button";
      btn.textContent = trait;
      btn.addEventListener("click", () => chooseTiebreakWinner(key));
      tbAnswers.appendChild(btn);
    });
  }

  function chooseTiebreakWinner(winner){
    roleScores[winner] = (roleScores[winner] || 0) + 1;

    pendingTie.nextRound.push(winner);
    pendingTie.currentPool = [];

    prepareNextPool();
  }

  // -------------------------
  // Events
  // -------------------------
  langSel.addEventListener("change", (e) => setLanguage(e.target.value));
  startBtn.addEventListener("click", start);

  // Restart = reset total (comme relancer le site)
  restartBtn.addEventListener("click", () => {
    location.reload();
  });

  backBtn.addEventListener("click", goBack);

  // Refaire le quiz depuis l‚Äô√©cran r√¥le
  retryFromRoleBtn.addEventListener("click", start);

  // Init
  setLanguage(langSel.value);
})();
</script>
</body>
</html>
